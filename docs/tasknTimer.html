

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>RTOS Tasks and Timers Reference &mdash; Victoria Makerspace  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script src="https://unpkg.com/mermaid@8.4.8/dist/mermaid.min.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="RFID Module - A Primer" href="MFRC522.html" />
    <link rel="prev" title="Firmware" href="Firmware.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Victoria Makerspace
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="PCBDesign.html">PCB Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="Firmware.html">Firmware</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">RTOS Tasks and Timers Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#rfid-tasks">RFID Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#estop-tasks">EStop Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#relay-task">Relay Task</a></li>
<li class="toctree-l2"><a class="reference internal" href="#addressable-led-tasks">Addressable LED Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mqtt-software-timers-and-callback-functions">MQTT software timers and callback functions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="MFRC522.html">RFID Module - A Primer</a></li>
<li class="toctree-l1"><a class="reference internal" href="Assembly.html">Assembly</a></li>
<li class="toctree-l1"><a class="reference internal" href="futureDevelopment.html">Roadmap to Further Development</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Victoria Makerspace</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>RTOS Tasks and Timers Reference</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/tasknTimer.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="rtos-tasks-and-timers-reference">
<h1>RTOS Tasks and Timers Reference<a class="headerlink" href="#rtos-tasks-and-timers-reference" title="Permalink to this headline">¶</a></h1>
<div class="section" id="rfid-tasks">
<h2>RFID Tasks<a class="headerlink" href="#rfid-tasks" title="Permalink to this headline">¶</a></h2>
<div class="topic">
<p class="topic-title"><code class="docutils literal notranslate"><span class="pre">pollNewTask</span> <span class="pre">(void</span> <span class="pre">*params)</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">pollNewTask()</span></code> is the entry point for the RFID control loop. Once it detects a new card it suspends itself. It is very important it is resumed at the appropriate places for the control loop to keep
functioning (ie. once we have entered <code class="docutils literal notranslate"><span class="pre">timeoutTask</span></code>). However, this also means that we can disable this task as a means of suspending the RFID functionality, see the EstopFire and
EstopClear tasks for more details.</p>
<p>This task also receives a task notification. This notification is made from <code class="docutils literal notranslate"><span class="pre">onMqttMessage()</span></code> when a card is denied by the server. The LEDParam structs are out of scope of the MQTT callback functions
of the AsynMQTTClient library and I could not figure out a way of passing them the value. Instead <code class="docutils literal notranslate"><span class="pre">pollNewTask()</span></code>, which is also resumed when a card is denied, is notified so that it may change the LEDParams
to blinking red.</p>
<p>When WiFi/MQTT is connected only CARD_BIT_0 is set in <code class="docutils literal notranslate"><span class="pre">pollNewTask()</span></code> and AUTH_BIT_1 is set elsewhere in <code class="docutils literal notranslate"><span class="pre">onMqttMessgae()</span></code> based the MQTT payload of <code class="docutils literal notranslate"><span class="pre">tool/auth/rsp</span></code>.
When a WiFi or MQTT disconnection event occurs WIFIOUT_BIT_7 is set. This is detected by bitmasking <code class="docutils literal notranslate"><span class="pre">xEventGroupGetBits(rfidStatesGroup)</span></code> to check the 7th bit (WIFIOUT_BIT_7)
to see if it has been set. If the WIFIOUT_BIT_7 has been set both CARD_BIT_0 and AUTH_BIT_1 are set within <code class="docutils literal notranslate"><span class="pre">pollNewTask()</span></code> without server authorization.
This is where future implementation for flash memory logging should be placed.</p>
<p>RTOS API calls summary</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 21%" />
<col style="width: 21%" />
<col style="width: 13%" />
<col style="width: 21%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>WaitBits()</p></th>
<th class="head"><p>SetBits()</p></th>
<th class="head"><p>GetBits ()</p></th>
<th class="head"><p>vTaskDelay()</p></th>
<th class="head"><p>TaskNotifyTake()</p></th>
<th class="head"><p>vTaskSuspend</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>N/A</p></td>
<td><p>If WIFIOUT_BIT_7 not set
CARD_BIT_0</p></td>
<td rowspan="2"><p>Used to check WIFIOUT_BIT_7</p></td>
<td rowspan="2"><p>MS_POLL_TIMER</p></td>
<td rowspan="2"><p>notificationValue == 1
toggle LEDparams   n
Red
blinkTemp</p></td>
<td rowspan="2"><p>NULL</p></td>
</tr>
<tr class="row-odd"><td><p>N/A</p></td>
<td><p>If WIFIOUT_BIT_7 is set
else CARD_BIT_0 | AUTH_BIT_1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="topic">
<p class="topic-title"><code class="docutils literal notranslate"><span class="pre">pollPresTask(void</span> <span class="pre">*params)</span></code></p>
<p>Unblocks when CARD_BIT_0 and AUTH_BIT_1 are set. Because both <code class="docutils literal notranslate"><span class="pre">pollPresTask</span></code> and <code class="docutils literal notranslate"><span class="pre">collPollTask</span></code> occur in the same state and both utilize the SPI bus a Mutex is given/taken by the two Tasks.
If <code class="docutils literal notranslate"><span class="pre">pollPres()</span></code> detects that a card has left the RF field the CARD_BIT_0 and AUTH_BIT_1 is cleared then the TIMEOUT_BIT_3 is set. This unblocks the <code class="docutils literal notranslate"><span class="pre">timeoutTask()</span></code> while placing both
<code class="docutils literal notranslate"><span class="pre">pollPresTask()</span></code> and <code class="docutils literal notranslate"><span class="pre">collPollTask()</span></code> back in the blocked state.</p>
<p>LEDs are set to blink blue when a card removal is detected.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 12%" />
<col style="width: 20%" />
<col style="width: 17%" />
<col style="width: 18%" />
<col style="width: 13%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head" rowspan="2"><p>WaitBits()</p></th>
<th class="head" rowspan="2"><p>SetBits()</p></th>
<th class="head" rowspan="2"><p>ClearBits ()</p></th>
<th class="head" rowspan="2"><p>vTaskDelay()</p></th>
<th class="head" rowspan="2"><p>SemaphoreGive/Take ()</p></th>
<th class="head" rowspan="2"><p>vTaskResume ()</p></th>
</tr>
<tr class="row-even"></tr>
</thead>
<tbody>
<tr class="row-odd"><td><p>CARD_BIT_0 | AUTH_BIT_1</p></td>
<td><p>TIMEOUT_BIT_3</p></td>
<td><p>CARD_BIT_0 | AUTH_BIT_1</p></td>
<td><p>MS_POLL_TIMER_PERIOD</p></td>
<td><p>SPIMutexHandle</p></td>
<td><p>blinkLEDHand0/1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="topic">
<p class="topic-title"><code class="docutils literal notranslate"><span class="pre">collPollTask(void</span> <span class="pre">*8*params)</span></code></p>
<p>Unblocks when CARD_BIT_0 and AUTH_BIT_1 are set. It gives/takes a mutes with <code class="docutils literal notranslate"><span class="pre">pollPresTask()</span></code> to avoid conflicting access of the SPI bus. If a collision is detected by <code class="docutils literal notranslate"><span class="pre">collPolling()</span></code>
CARD_BIT_0 | AUTH_BIT_1 are cleared and the TIMEOUT_BIT_3 | COLL_BIT_4 are set in order to execute a transition to the timeout state.</p>
<p>LEDs are set to blink purple to indicate a collision has been detected.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 20%" />
<col style="width: 18%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head" rowspan="2"><p>WaitBits()</p></th>
<th class="head" rowspan="2"><p>SetBits()</p></th>
<th class="head" rowspan="2"><p>ClearBits ()</p></th>
<th class="head" rowspan="2"><p>vTaskDelay()</p></th>
<th class="head" rowspan="2"><p>SemaphoreGive/Take ()</p></th>
<th class="head" rowspan="2"><p>vTaskResume ()</p></th>
</tr>
<tr class="row-even"></tr>
</thead>
<tbody>
<tr class="row-odd"><td><p>CARD_BIT_0 | AUTH_BIT_1</p></td>
<td><p>TIMEOUT_BIT_3 | COLL_BIT_4</p></td>
<td><p>CARD_BIT_0 | AUTH_BIT_1</p></td>
<td><p>?</p></td>
<td><p>SPIMutexHandle</p></td>
<td><p>blinkLEDHand0/1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="topic">
<p class="topic-title"><code class="docutils literal notranslate"><span class="pre">timeoutTask</span> <span class="pre">(void</span> <span class="pre">*params)</span></code></p>
<p>Unblocks on the TIMEOUT_BIT_3. The first thing that is done is publishing to the MQTT <code class="docutils literal notranslate"><span class="pre">rfid/auth/eou</span></code> (end of use) topic. This is done before
<code class="docutils literal notranslate"><span class="pre">pollNewTask()</span></code> is resumed so that it cannot be interrupted by introduction of a new card. Next <code class="docutils literal notranslate"><span class="pre">closeRelayTask</span></code> is resumed so that if a new card is introduced
the relay can be closed. A bitmask operation is carried out against <code class="docutils literal notranslate"><span class="pre">xEventGroupGetBits</span></code> to determine if both TIMEOUT_BIT_3 and COLL_BIT_4 are set.</p>
<p>If just TIMEOUT_BIT_3 is set <code class="docutils literal notranslate"><span class="pre">pollNewTask()</span></code> is resumed so that a new card can be introduced and authorized without the relay being opened.</p>
<p>If TIMEOUT_BIT_3 and COLL_BIT_4 is set the full timeout is enforced and the relay is re-opened before <code class="docutils literal notranslate"><span class="pre">pollNewTask()</span></code> is resumed.</p>
<p>When the full timeout occurs RELAY_BIT_2, TIMEOUT_BIT_3, and COLL_BIT_4 are all cleared.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 20%" />
<col style="width: 24%" />
<col style="width: 26%" />
<col style="width: 16%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head" rowspan="2"><p>WaitBits()</p></th>
<th class="head" rowspan="2"><p>ClearBits()</p></th>
<th class="head" rowspan="2"><p>GetBits ()</p></th>
<th class="head" rowspan="2"><p>vTaskDelay()</p></th>
<th class="head" rowspan="2"><p>vTaskResume ()</p></th>
</tr>
<tr class="row-even"></tr>
</thead>
<tbody>
<tr class="row-odd"><td rowspan="2"><p>TIMEOUT_BIT_3</p></td>
<td rowspan="2"><p>RELAY_BIT_2 | TIMEOUT_BIT_3</p></td>
<td rowspan="2"><p>Used to check if TIMEOUT_BIT_3</p>
<p>and/or COLL_BIT_4 is set</p>
</td>
<td rowspan="2"><p>MS_TIMEOUT_PERIOD</p></td>
<td rowspan="2"><p>blinkLEDHand0/1</p>
<p>pollNewHandle</p>
</td>
</tr>
<tr class="row-even"></tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="estop-tasks">
<h2>EStop Tasks<a class="headerlink" href="#estop-tasks" title="Permalink to this headline">¶</a></h2>
<div class="topic">
<p class="topic-title"><code class="docutils literal notranslate"><span class="pre">eStopFireTask</span> <span class="pre">(void</span> <span class="pre">*params)</span></code></p>
<p>Unblocks on ESTOPFIRE_BIT_5 which is set in <code class="docutils literal notranslate"><span class="pre">onMqttMessage()</span></code> on receipt of <code class="docutils literal notranslate"><span class="pre">rfid/estop/fire</span></code>. A <code class="docutils literal notranslate"><span class="pre">xEventGroupGetBits()</span></code> is used to check the state of the hardware. If
no bits are set <code class="docutils literal notranslate"><span class="pre">pollNewTask()</span></code> is suspended cutting off the access point to the RFID functionality. If any of the EventBits are set all the bits are cleared, the relay is
opened and then <code class="docutils literal notranslate"><span class="pre">pollNewTask()</span></code> is suspended. The LEDs are then set to flash yellow.</p>
<p>The ESTOPSET_BIT_6 auto clears on the the successful <code class="docutils literal notranslate"><span class="pre">xEventGroupWaitBits()</span></code>.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 23%" />
<col style="width: 48%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head" rowspan="2"><p>WaitBits()</p></th>
<th class="head" rowspan="2"><p>GetBits ()</p></th>
<th class="head" rowspan="2"><p>ClearBits()</p></th>
<th class="head" rowspan="2"><p>vTaskResume ()</p></th>
</tr>
<tr class="row-even"></tr>
</thead>
<tbody>
<tr class="row-odd"><td rowspan="2"><p>ESTOPFIRE_BIT_5</p></td>
<td><p>If no bits set</p></td>
<td><p>N/A</p></td>
<td rowspan="2"><p>blinkLEDHand0/1</p>
<p>pollNewHandle</p>
</td>
</tr>
<tr class="row-even"><td><p>If bit other than ESTOPbits set</p></td>
<td><p>CARD_BIT_0 | AUTH_BIT_1 | RELAY_BIT_2 | TIMEOUT_BIT_3 | COLL_BIT_4</p></td>
</tr>
</tbody>
</table>
</div>
<div class="topic">
<p class="topic-title"><code class="docutils literal notranslate"><span class="pre">eStopClearTask</span> <span class="pre">(void</span> <span class="pre">*params)</span></code></p>
<p>Unblocks on ESTOPCLEAR_BIT_6 which is set in <code class="docutils literal notranslate"><span class="pre">onMqttMessage()</span></code> on receipt of <code class="docutils literal notranslate"><span class="pre">rfid/estop/fire</span></code>. This task simply turns off the LEDs and resumes <code class="docutils literal notranslate"><span class="pre">pollNewTask()</span></code>.
The ESTOPCLEAR_BIT_6 auto clears on the the successful <code class="docutils literal notranslate"><span class="pre">xEventGroupWaitBits()</span></code>.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 60%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head" rowspan="2"><p>WaitBits()</p></th>
<th class="head" rowspan="2"><p>vTaskResume ()</p></th>
</tr>
<tr class="row-even"></tr>
</thead>
<tbody>
<tr class="row-odd"><td rowspan="2"><p>ESTOPCLEAR_BIT_5</p></td>
<td rowspan="2"><p>blinkLEDHand0/1</p>
<p>pollNewHandle</p>
</td>
</tr>
<tr class="row-even"></tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="relay-task">
<h2>Relay Task<a class="headerlink" href="#relay-task" title="Permalink to this headline">¶</a></h2>
<div class="topic">
<p class="topic-title"><code class="docutils literal notranslate"><span class="pre">closeRelayTask(void</span> <span class="pre">*params)</span></code></p>
<p>Unblocks once CARD_BIT_0 and AUTH_BIT_1 are set. It closes the relay, sets the RELAY_BIT_2 (not currently used for anything), changes the LEDs to a solid green to
indicate this to the user. The task then suspends itself once all of this has been achieved. This task is resumed in <code class="docutils literal notranslate"><span class="pre">timeoutTask()</span></code>.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 27%" />
<col style="width: 18%" />
<col style="width: 35%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head" rowspan="2"><p>WaitBits()</p></th>
<th class="head" rowspan="2"><p>SetBits()</p></th>
<th class="head" rowspan="2"><p>vTaskSuspend ()</p></th>
<th class="head" rowspan="2"><p>vTaskResume ()</p></th>
</tr>
<tr class="row-even"></tr>
</thead>
<tbody>
<tr class="row-odd"><td><p>CARD_BIT_0|AUTH_BIT_1</p></td>
<td><p>RELAY_BIT_2</p></td>
<td><p>NULL</p></td>
<td><p>blinkLEDHand0/1</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="addressable-led-tasks">
<h2>Addressable LED Tasks<a class="headerlink" href="#addressable-led-tasks" title="Permalink to this headline">¶</a></h2>
<p>Library : <a class="reference external" href="https://github.com/FastLED/FastLED">FastLED</a></p>
<p>Control of the COM12999 addressable LEDs is done via the FastLED library, a single RTOS task definition <code class="docutils literal notranslate"><span class="pre">blinkyLEDTask</span></code> and a single software timer <code class="docutils literal notranslate"><span class="pre">LEDblinkTimer</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">blinky LED Task</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-C++ notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">blinkyLED</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">params</span><span class="p">){</span>

   <span class="n">LEDParams</span> <span class="o">*</span><span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">LEDParams</span><span class="o">*</span><span class="p">)</span><span class="n">params</span><span class="p">;</span> <span class="c1">// Dumping our struct parameters into task instance of LEDParams via casting of void *params to LEDParams</span>


   <span class="k">for</span> <span class="p">(;;){</span> <span class="c1">// Infinite loop required for RTOS tasks b/c if allowed to return they would delete</span>

      <span class="c1">// Branch based on blink status</span>
      <span class="k">if</span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">blink</span><span class="p">){</span>                             <span class="c1">// if blink flag has been set</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">blinkTemp</span><span class="p">){</span>                 <span class="c1">// If the blinkTemp flag is set we start the LEDblinkTimer</span>
              <span class="n">l</span><span class="o">-&gt;</span><span class="n">blinkTemp</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>               <span class="c1">// Only want the timer started once</span>
             <span class="n">xTimerStart</span><span class="p">(</span><span class="n">LEDblinkTimer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// Start the timer</span>
         <span class="p">}</span>

         <span class="n">leds</span><span class="p">[</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">]</span> <span class="o">=</span> <span class="n">CRGB</span><span class="o">::</span><span class="n">Black</span><span class="p">;</span>            <span class="c1">// Set LED specified in passed params to OFF state</span>
         <span class="n">FastLED</span><span class="p">.</span><span class="n">show</span><span class="p">();</span>                        <span class="c1">// Toggle the LED state to new</span>
         <span class="n">vTaskDelay</span><span class="p">(</span><span class="n">pdMS_TO_TICKS</span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">));</span>    <span class="c1">// RTOS delay blocks task not processor</span>

         <span class="n">leds</span><span class="p">[</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">myColour</span><span class="p">;</span>            <span class="c1">// Set LED specified in passed params to the colour specified in same passed params</span>
         <span class="n">FastLED</span><span class="p">.</span><span class="n">show</span><span class="p">();</span>
         <span class="n">vTaskDelay</span><span class="p">(</span><span class="n">pdMS_TO_TICKS</span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">));</span>   <span class="c1">// Set delay time according to passed param AND div by port TICK period ms</span>
      <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span>
         <span class="n">leds</span><span class="p">[</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">myColour</span><span class="p">;</span>            <span class="c1">// Set LED specified in passed params to the colour specified in same passed params</span>
         <span class="n">FastLED</span><span class="p">.</span><span class="n">show</span><span class="p">();</span>                        <span class="c1">// Show it</span>
         <span class="n">vTaskSuspend</span> <span class="p">(</span> <span class="nb">NULL</span> <span class="p">);</span>                 <span class="c1">// Suspend ourselves since blink = false therefore the task need not keep running</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

 <span class="kt">void</span> <span class="nf">LEDTimerCallback</span> <span class="p">(</span><span class="n">TimerHandle_t</span> <span class="n">LEDblinkTimer</span><span class="p">){</span>
     <span class="n">metaStruct</span> <span class="o">*</span><span class="n">progParams</span> <span class="o">=</span> <span class="p">(</span><span class="n">metaStruct</span><span class="o">*</span><span class="p">)</span> <span class="n">pvTimerGetTimerID</span> <span class="p">(</span><span class="n">LEDblinkTimer</span><span class="p">);</span>

     <span class="n">progParams</span><span class="o">-&gt;</span><span class="n">LEDParams0</span><span class="p">.</span><span class="n">myColour</span> <span class="o">=</span> <span class="n">CRGB</span><span class="o">::</span><span class="n">Black</span><span class="p">;</span> <span class="c1">// Once our timer expires our callback function simply resets out LEDs to off</span>
     <span class="n">progParams</span><span class="o">-&gt;</span><span class="n">LEDParams1</span><span class="p">.</span><span class="n">myColour</span> <span class="o">=</span> <span class="n">CRGB</span><span class="o">::</span><span class="n">Black</span><span class="p">;</span>
     <span class="n">progParams</span><span class="o">-&gt;</span><span class="n">LEDParams0</span><span class="p">.</span><span class="n">blink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="n">progParams</span><span class="o">-&gt;</span><span class="n">LEDParams1</span><span class="p">.</span><span class="n">blink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Where the LED control tasks differ slightly from the other RTOS tasks is at creation they are passed the address of their parameter struct rather than the address of the metaStruct. The LED tasks
need only access to the LED parameters while other tasks needs access to their own parameters and the LED parameters.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">LED Task and Timer Creation in void setup ()</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="c1">//Task creation</span>
<span class="n">xTaskCreatePinnedToCore</span><span class="p">(</span><span class="n">blinkyLED</span><span class="p">,</span> <span class="s">&quot;blinkLED&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">progParams</span><span class="p">.</span><span class="n">LEDParams0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blinkLEDHandle0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">xTaskCreatePinnedToCore</span><span class="p">(</span><span class="n">blinkyLED</span><span class="p">,</span> <span class="s">&quot;blinkLED1&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">progParams</span><span class="p">.</span><span class="n">LEDParams1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blinkLEDHandle1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="c1">// Software timer creation</span>
<span class="n">LEDblinkTimer</span> <span class="o">=</span> <span class="n">xTimerCreate</span><span class="p">(</span><span class="s">&quot;LEDblinkTimer&quot;</span><span class="p">,</span> <span class="n">LEDBLINK_PERIOD</span><span class="p">,</span> <span class="n">pdFALSE</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">progParams</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">TimerCallbackFunction_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">LEDTimerCallback</span><span class="p">));</span>
</pre></div>
</div>
</div>
<p>Manipulation of the LEDs can then be achieve simply by changing the values held in <code class="docutils literal notranslate"><span class="pre">LEDParams0</span></code> and <code class="docutils literal notranslate"><span class="pre">LEDParams1</span></code> via the void pointer.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the previous state of an LED was <code class="docutils literal notranslate"><span class="pre">blink</span> <span class="pre">==</span> <span class="pre">0</span></code> then its respective LEDTask will have to be resumed.</p>
</div>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Example LED manipulation</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">exampleTask</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="n">params</span><span class="p">){</span>
<span class="n">metaStruct</span> <span class="o">*</span><span class="n">progParams</span> <span class="o">=</span> <span class="p">(</span><span class="n">metaStruct</span><span class="o">*</span><span class="p">)</span> <span class="n">params</span><span class="p">;</span>

   <span class="k">for</span><span class="p">(;;){</span>
    <span class="n">progParams</span><span class="o">-&gt;</span><span class="n">LEDParams0</span><span class="o">.</span><span class="n">myColour</span> <span class="o">=</span> <span class="n">CRGB</span><span class="p">::</span><span class="n">Red</span><span class="p">;</span>     <span class="o">//</span> <span class="n">Set</span> <span class="n">LED0</span> <span class="n">to</span> <span class="n">Red</span>
    <span class="n">progParams</span><span class="o">-&gt;</span><span class="n">LEDParams1</span><span class="o">.</span><span class="n">myColour</span> <span class="o">=</span> <span class="n">CRGB</span><span class="p">::</span><span class="n">Purple</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Set</span> <span class="n">LED1</span> <span class="n">to</span> <span class="n">Purple</span>
    <span class="n">progParams</span><span class="o">-&gt;</span><span class="n">LEDParams0</span><span class="o">.</span><span class="n">blink</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                <span class="o">//</span> <span class="n">Set</span> <span class="n">LED0</span> <span class="n">to</span> <span class="n">continuous</span> <span class="n">one</span>
    <span class="n">progParams</span><span class="o">-&gt;</span><span class="n">LEDParams1</span><span class="o">.</span><span class="n">blink</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                <span class="o">//</span> <span class="n">Set</span> <span class="n">LED1</span> <span class="n">to</span> <span class="n">blink</span>
    <span class="o">//</span> <span class="n">Without</span> <span class="n">changing</span> <span class="n">progParams</span><span class="o">-&gt;</span><span class="n">LEDParams1</span><span class="o">.</span><span class="n">time</span> <span class="n">LED1</span> <span class="n">will</span> <span class="n">blink</span> <span class="n">at</span> <span class="n">whatever</span> <span class="n">period</span> <span class="n">was</span> <span class="n">last</span> <span class="n">defined</span> <span class="n">there</span>

   <span class="n">vTaskResume</span><span class="p">(</span><span class="n">blinkLEDHandle0</span><span class="p">);</span> <span class="o">//</span> <span class="n">Resume</span> <span class="n">the</span> <span class="n">LED</span> <span class="n">task</span>
   <span class="n">vTaskResume</span><span class="p">(</span><span class="n">blinkLEDHandle1</span><span class="p">);</span> <span class="o">//</span> <span class="n">Resume</span> <span class="n">the</span> <span class="n">LED</span> <span class="n">task</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="mqtt-software-timers-and-callback-functions">
<h2>MQTT software timers and callback functions<a class="headerlink" href="#mqtt-software-timers-and-callback-functions" title="Permalink to this headline">¶</a></h2>
<p>The MQTT funcitonality utilizes software timers to handle disconnection/reconnection events from WiFi and the MQTT server. These are found in <code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">setup()</span></code> of
<code class="docutils literal notranslate"><span class="pre">toolAccessRTOS.ino</span></code>.</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">mqttReconnectTimer</span> <span class="o">=</span> <span class="n">xTimerCreate</span><span class="p">(</span><span class="s">&quot;mqttTimer&quot;</span><span class="p">,</span> <span class="n">MS_MQTT_RECONNECT_PERIOD</span><span class="p">,</span> <span class="n">pdFALSE</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">TimerCallbackFunction_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">connectToMqtt</span><span class="p">));</span>
<span class="n">wifiReconnectTimer</span> <span class="o">=</span> <span class="n">xTimerCreate</span><span class="p">(</span><span class="s">&quot;wifiTimer&quot;</span><span class="p">,</span> <span class="n">MS_WIFI_RECONNECT_PERIOD</span><span class="p">,</span> <span class="n">pdFALSE</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">TimerCallbackFunction_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">connectToWifi</span><span class="p">));</span>
</pre></div>
</div>
<p>As mentioned above, the MQTT functions are those included in the <code class="docutils literal notranslate"><span class="pre">FullyFeatured-ESP32.ino</span></code> example included with the library. Most of them remain unmodified, the exceptions to this are
<code class="docutils literal notranslate"><span class="pre">connectToWifi()</span></code>,  <code class="docutils literal notranslate"><span class="pre">WiFiEvent()</span></code>, <code class="docutils literal notranslate"><span class="pre">onMqttConnect()</span></code>, and <code class="docutils literal notranslate"><span class="pre">onMqttMessage()</span></code> . As such I will only discuss these functions here.</p>
<div class="topic">
<p class="topic-title"><code class="docutils literal notranslate"><span class="pre">connectToWifi()</span></code></p>
<p>WiFi credentials are accessed here. Create your own <code class="docutils literal notranslate"><span class="pre">credentials.h</span></code> with <code class="docutils literal notranslate"><span class="pre">#define</span> <span class="pre">SSID,</span> <span class="pre">PASS</span></code>.</p>
</div>
<div class="topic">
<p class="topic-title"><code class="docutils literal notranslate"><span class="pre">WiFiEvent()</span></code></p>
<p>WIFIOUT_BIT_7 is set here when disconnection occurs to change behaviour of <code class="docutils literal notranslate"><span class="pre">pollNewTask()</span></code></p>
</div>
<div class="topic">
<p class="topic-title"><code class="docutils literal notranslate"><span class="pre">onMqttConnect()</span></code></p>
<p>Hardcoded subscriptions can be placed here. Ideally in the future have the subscriptions read out of a modifyable variable/struct/JSON doc would
allow for modification of those subscriptions. See Whomami implementation in Roadmap to Further Development section.</p>
</div>
<div class="topic">
<p class="topic-title"><code class="docutils literal notranslate"><span class="pre">onMqttMessage()</span></code></p>
<p>MQTT payloads from subscriptions enter here. Payloads are read and operated on resulting in the possible setting or clearing of various EventBits:</p>
<p>Task notification: 0’th bit of <code class="docutils literal notranslate"><span class="pre">pollNewHandle</span></code> is set to notify the <code class="docutils literal notranslate"><span class="pre">pollNewTask()</span></code> that a card has been denied and to blink red LEDs at the user.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 9%" />
<col style="width: 14%" />
<col style="width: 19%" />
<col style="width: 25%" />
<col style="width: 13%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Topic</p></th>
<th class="head"><p>Payload</p></th>
<th class="head"><p>SetBits()</p></th>
<th class="head"><p>ClearBits()</p></th>
<th class="head"><p>xTaskNotify()</p></th>
<th class="head"><p>vTaskResume ()</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td rowspan="3"><p>rfid/auth/rsp</p></td>
<td><p>auth</p></td>
<td><p>AUTH_BIT_1</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
</tr>
<tr class="row-odd"><td><p>denied</p></td>
<td><p>N/A</p></td>
<td><p>CARD_BIT_0 | AUTH_BIT_1</p></td>
<td><p>pollNewHandle, (1&lt;&lt;0), eSetBits</p></td>
<td><p>pollNewHandle</p></td>
</tr>
<tr class="row-even"><td><p>seekiosk</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
</tr>
<tr class="row-odd"><td rowspan="2"><p>rfid/estop</p></td>
<td><p>fire</p></td>
<td><p>ESTOPFIRE_BIT_5</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
</tr>
<tr class="row-even"><td><p>clear</p></td>
<td><p>ESTOPCLEAR_BIT_5</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Care should be taken using <code class="docutils literal notranslate"><span class="pre">strncmp()</span></code> to evaluate topics and payloads. Specifically, the <code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">num</span></code> parameter should be utilized where possible as payloads may
be coming from non-null terminating languages such as Java-script.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="MFRC522.html" class="btn btn-neutral float-right" title="RFID Module - A Primer" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Firmware.html" class="btn btn-neutral float-left" title="Firmware" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Liam Brinston

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>